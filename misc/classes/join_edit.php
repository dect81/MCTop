<?phpif($debug) {	$file = __FILE__;	debug::include_report($file);}class join_edit extends base {   function check_input($type) {    global $CONF, $DB, $FORM, $LNG, $TMPL;    $error_username = 0;    $error_username_duplicate = 0;    $error_password = 0;    $error_confirm_password = 0;    $error_url = 0;    $error_email = 0;    $error_title = 0;    $error_banner_url = 0;    $error_captcha = 0;    $error_security_question = 0;    $error_av_online = 0;    $error_serv_version = 0;    $error_serv_ip = 0;    $error_serv_port = 0;	$error_email_duplicate = 0;    // Filter the URL using a regex I found here: http://www.manamplified.org/archives/000318.html    preg_match('/[A-Za-z][A-Za-z0-9+.-]{1,120}:[A-Za-z0-9\/](([A-Za-z0-9$_.+!*,;\/?:@&~=-])|%[A-Fa-f0-9]{2}){1,333}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*,;\/?:@&~=%-]{0,1000}))?/', $TMPL['url'], $matches);    $TMPL['url'] = isset($matches[0]) ? $matches[0] : $TMPL['url'];    preg_match('/[A-Za-z][A-Za-z0-9+.-]{1,120}:[A-Za-z0-9\/](([A-Za-z0-9$_.+!*,;\/?:@&~=-])|%[A-Fa-f0-9]{2}){1,333}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*,;\/?:@&~=%-]{0,1000}))?/', $TMPL['banner_url'], $matches);    $TMPL['banner_url'] = isset($matches[0]) ? $matches[0] : $TMPL['banner_url'];    if ($type == 'join') {	      if (!preg_match('/^[a-zA-Z0-9\-_]+$/', $FORM['u'])) {        $error_username = 1;      }      list($username_sql) = $DB->fetch("SELECT username FROM {$CONF['sql_prefix']}_servers WHERE username = '{$TMPL['username']}'", __FILE__, __LINE__);      if ($username_sql && $username_sql == $TMPL['username']) {        $error_username_duplicate = 1;      }      list($email_sql) = $DB->fetch("SELECT email FROM {$CONF['sql_prefix']}_servers WHERE email = '{$TMPL['email']}'", __FILE__, __LINE__);      if ($email_sql && $email_sql == $TMPL['email']) {        $error_email_duplicate = 1;      }      if (!$FORM['password']) {        $error_password = 1;      }      if (!$FORM['av_online']) {        $error_av_online = 1;      }      if (!$FORM['version']) {        $error_serv_version = 1;      }      if (!$FORM['ip']) {        $error_serv_ip = 1;      }      if (!$FORM['port']) {        $error_serv_port = 1;      }      if ($FORM['password'] != $FORM['confirm_password']) {        $error_confirm_password = 1;      }      if ($CONF['captcha']) {        $ip = $DB->escape($_SERVER['REMOTE_ADDR'], 1);        list($sid) = $DB->fetch("SELECT sid FROM {$CONF['sql_prefix']}_sessions WHERE type = 'captcha' AND data LIKE '{$ip}|%'", __FILE__, __LINE__);        require_once("{$CONF['path']}/sources/misc/session.php");        $session = new session;        list($type, $data) = $session->get($sid);        list($ip, $hash) = explode('|', $data);        if (!isset($FORM['captcha']) || $hash != sha1(')F*RJ@FHR^%X'.$FORM['captcha'].'(*Ht3h7f9&^F'.$ip)) {          $error_captcha = 1;        }        $session->delete($sid);      }      if ($CONF['security_question'] && $CONF['security_answer']) {        if ($FORM['security_answer'] != $CONF['security_answer']) {          $error_security_question = 1;        }      }    }    if (!preg_match('/^https?:\/\/.+/', $TMPL['url'])) {      $error_url = 1;    }    if (!preg_match('/^([a-zA-Z0-9])+([a-zA-Z0-9._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9._-]+)+$/', $TMPL['email'])) {      $error_email = 1;    }    if (!$TMPL['title']) {      $error_title = 1;    }    if (!preg_match('/^https?:\/\/.+/', $TMPL['banner_url'])) {      $TMPL['banner_url'] = $CONF['default_banner'];    }	if($TMPL['register']!=1 and $TMPL['admin']!=1){			if ($CONF['max_banner_width'] && $CONF['max_banner_height'] && ini_get('allow_url_fopen')) {		  $size = getimagesize($FORM['banner_url']);		  if (!($size[0] == $CONF['max_banner_width'] and $size[1] == $CONF['max_banner_height'])) {			$error_banner_url = 1;		  }		  if (!isset($size[0]) && !isset($size[1])) { $error_banner_url = 1; }		}			}    $good_cat = 0;    foreach ($CONF['categories'] as $cat => $skin) {      if ($TMPL['category'] == $cat) {        $good_cat = 1;      }    }    if (!$good_cat) {      $TMPL['category'] = $cat;    }    if ($error_username || $error_av_online || $error_username_duplicate || $error_email_duplicate || $error_password || $error_confirm_password || $error_url || $error_email || $error_title || $error_banner_url || $error_captcha || $error_security_question) {      if ($error_username) {        $TMPL['error_username'] = "<br />{$LNG['join_error_username']}";      }      if ($error_dupl_serv) {        $TMPL['error_dupl_serv'] = "{$LNG['join_error_server_duplicate']}";      }      if ($error_username_duplicate) {        $TMPL['error_username'] = "<br />{$LNG['join_error_username_duplicate']}";      }      if ($error_email_duplicate) {        $TMPL['error_email_duplicate'] = "<br />{$LNG['join_error_email_duplicate']}";      }	        $TMPL['error_password'] = "<br />{$LNG['join_error_password']}";      if ($error_confirm_password) {        $TMPL['error_password'] = "<br />{$LNG['join_error_confirm_password']}";      }      if ($error_av_online) {                                              // Edited        $TMPL['error_av_online'] = "<br />{$LNG['join_error_av_online']}"; //      }      if ($error_serv_version) {                                              // Edited        $TMPL['error_serv_version'] = "<br />{$LNG['join_error_serv_version']}"; //      }      if($error_serv_ip) {        $TMPL['error_serv_ip'] = "<br />{$LNG['add_server_error_ip']}"; //      }                                                                    //      if ($error_url) {        $TMPL['error_url'] .= "<br />{$LNG['join_error_url']}";      }      if ($error_email) {        $TMPL['error_email'] .= "<br />{$LNG['join_error_email']}";      }      if ($error_title) {        $TMPL['error_title'] .= "<br />{$LNG['join_error_title']}";      }      if ($error_banner_url) {        $TMPL['error_banner_url'] .= "<br />{$LNG['join_error_urlbanner']}";      }      $TMPL['error_style_captcha'] = 'join_edit_error';      if ($error_captcha) {        $TMPL['error_captcha'] .= "<br />{$LNG['join_error_captcha']}";      }      if ($error_security_question) {        $TMPL['error_question'] .= "<br />{$LNG['join_error_question']}";      }      $TMPL['error_style_top'] = 'join_edit_error';      $TMPL['error_top'] = $LNG['join_error_top'];      return 0;    }    else {	      return 1;    }  }  function add_server_check_input() {    global $CONF, $DB, $FORM, $LNG, $TMPL;    $error_title = 0;    $error_version = 0;    $error_ip = 0;    $error_port = 0;    $error_description = 0;	if (!$FORM['serv_version']) {		$error_version = 1;	}	if (!$FORM['serv_ip']) {		$error_ip = 1;	}	if (!$FORM['port']) {		$error_port = 1;	}    if (!$TMPL['title']) {		$error_title = 1;    }	if (!$FORM['description']) {		$error_description = 1;	}    if ($error_title || $error_version || $error_ip || $error_port || $error_description) {      if ($error_version) {                                                      $TMPL['error_version'] = "<br/>{$LNG['add_server_error_version']}";       }      if($error_ip) {        $TMPL['error_ip'] = "<br/>{$LNG['add_server_error_ip']}";       }                                                                          if ($error_title) {        $TMPL['error_title'] .= "<br/>{$LNG['add_server_error_title']}";      }      if ($error_port) {        $TMPL['error_port'] .= "<br/>{$LNG['add_server_error_port']}";      }      if ($error_description) {        $TMPL['error_description'] .= "<br/>{$LNG['add_server_error_description']}";      }      return 0;    }    else {	      return 1;    }  }  function adv_check_input($type) {    global $CONF, $DB, $FORM, $LNG, $TMPL;    // Filter the URL using a regex I found here: http://www.manamplified.org/archives/000318.html    $TMPL['img_url'] = isset($matches[0]) ? $matches[0] : $TMPL['img_url'];    if (!preg_match('/^https?:\/\/.+/', $TMPL['url'])) {      $error_url = 1;    }    if (!preg_match('/^([a-zA-Z0-9])+([a-zA-Z0-9._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9._-]+)+$/', $TMPL['email'])) {      $error_email = 1;    }    if (!$TMPL['title']) {      $error_title = 1;    }    if (!$TMPL['descr']) {      $error_descr = 1;    }    if (!preg_match('/^https?:\/\/.+/', $TMPL['img_url'])) {      $error_banner_url = 1;    }    elseif ($CONF['adv_max_banner_width'] && $CONF['adv_max_banner_height'] && ini_get('allow_url_fopen')) {      $size = getimagesize($FORM['img_url']);      if ($size[0] > $CONF['adv_max_banner_width'] || $size[1] > $CONF['adv_max_banner_height']) {        $error_banner_url = 1;      }      if (!isset($size[0]) && !isset($size[1])) { $error_banner_url = 1; }    }	    if ($error_title || $error_url || $error_descr || $error_banner_url) {      if ($error_title) {        $TMPL['error_title'] .= "<br />{$LNG['adv_error_title']}";      }                                                                 //      if ($error_url) {        $TMPL['error_url'] .= "<br />{$LNG['join_error_url']}";      }     if ($error_descr) {        $TMPL['error_descr'] .= "<br />{$LNG['adv_error_descr']}";      }      if ($error_banner_url) {        $TMPL['error_banner_url'] .= "<br />{$LNG['adv_error_urlbanner']}";        $TMPL['error_style_banner_url'] = 'join_edit_error';      }      $TMPL['error_style_captcha'] = 'join_edit_error';      $TMPL['error_style_top'] = 'join_edit_error';      $TMPL['error_top'] = $LNG['join_error_top'];      return 0;    }    else {      return 1;    }  }  // This should be called before check_input  function check_ban($type) {    global $CONF, $DB, $FORM, $LNG, $TMPL;    $ban_url = 0;    $ban_email = 0;    $ban_username = 0;    $ban_ip = 0;   if ($type == 'join') { $fields = array('url', 'email', 'username', 'ip'); }   elseif ($type == 'edit') { $fields = array('url', 'email'); }   elseif ($type == 'review') { $fields = array('ip'); }    //$TMPL['ip'] = $DB->escape($_SERVER['REMOTE_ADDR'], 1);    $result = $DB->query("SELECT id, string, field, matching FROM {$CONF['sql_prefix']}_ban", __FILE__, __LINE__);    while (list($id, $string, $field, $matching) = $DB->fetch_array($result)) {      if (in_array($field, $fields)) {        $string = preg_quote($string);        if ($matching) { $s = "^{$string}$"; } // Exact matching        else { $s = $string; } // Global matching        if (preg_match("|{$s}|", $TMPL[$field])) {          $ban_url = 1;        }      }    }    if ($ban_url || $ban_email || $ban_username || $ban_ip) {      $TMPL['error_style_top'] = 'join_edit_error';      $TMPL['error_top'] = $LNG['join_ban_top'];      return 0;    }    else {      return 1;    }  }}?>